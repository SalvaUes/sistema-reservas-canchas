<div class="dashboard">
  <!-- Panel lateral -->
  <aside
    class="side-panel"
    [class.closed]="isSidePanelClosed"
    (mouseenter)="hoverPanel(true)"
    (mouseleave)="hoverPanel(false)"
  >
    <button class="toggle-btn" (click)="toggleSidePanel()">
      {{ isSidePanelClosed ? '‚ò∞' : '‚úï' }}
    </button>
    <h2 *ngIf="!isSidePanelClosed">Panel Admin</h2>

    <nav>
      <a routerLink="/admin" routerLinkActive="active" matTooltip="Inicio">
        <i class="fas fa-home"></i>
        <span *ngIf="!isSidePanelClosed">Inicio</span>
      </a>
      <a routerLink="/admin/usuarios" routerLinkActive="active" matTooltip="Usuarios">
        <i class="fas fa-users"></i>
        <span *ngIf="!isSidePanelClosed">Usuarios</span>
      </a>
      <a routerLink="/admin/canchas" routerLinkActive="active" matTooltip="Canchas">
        <i class="fas fa-futbol"></i>
        <span *ngIf="!isSidePanelClosed">Canchas</span>
      </a>
      <a routerLink="/admin/reservas" routerLinkActive="active" matTooltip="Reservas">
        <i class="fas fa-calendar-check"></i>
        <span *ngIf="!isSidePanelClosed">Reservas</span>
      </a>

    </nav>

    <div class="user-info" *ngIf="!isSidePanelClosed">
      <p>{{ userEmail }}</p>
      <p>{{ userRole }}</p>
    </div>

    <button class="logout-btn" matTooltip="Cerrar sesi√≥n" (click)="logout()">
      <i class="fas fa-sign-out-alt"></i>
      <span *ngIf="!isSidePanelClosed">Cerrar sesi√≥n</span>
    </button>
  </aside>

  <!-- Contenido principal -->
  <main [class.closed]="isSidePanelClosed">
    <section class="reservas-section">
      <h1>Reservaciones</h1>

      <!-- Buscador y bot√≥n a√±adir -->
      <div class="usuarios-header">
        <input
          type="text"
          placeholder="Buscar por usuario, cancha o c√≥digo..."
          [(ngModel)]="searchTerm"
          (input)="filterReservations()"
          autocomplete="off"
          spellcheck="false"
        />
      
        <label for="filterStatus">Estado:</label>
        <select
          id="filterStatus"
          [(ngModel)]="filterStatus"
          (change)="filterReservations()"
        >
          <option value="">Todos</option>
          <option value="PENDING">Pendiente</option>
          <option value="CONFIRMED">Confirmada</option>
          <option value="FINISHED">Finalizada</option>
          <option value="CANCELLED">Cancelada</option>
        </select>
      
        <button class="add-btn" (click)="openForm(false)">
          A√±adir Reservaci√≥n
        </button>
      </div>

      <!-- Modal formulario -->
      <div
        class="modal-backdrop"
        *ngIf="showForm"
        (click)="cancelForm()"
      >
        <div class="modal" (click)="$event.stopPropagation()">
          <h2>{{ editMode ? 'Editar Reservaci√≥n' : 'Nueva Reservaci√≥n' }}</h2>

          <div class="form-group">
            <label>Usuario*:</label>
            <select [(ngModel)]="userId">
              <option *ngFor="let user of users" [value]="user.id">
                {{ user.firstName }} {{ user.lastName }} ({{ user.email }})
              </option>
            </select>
          </div>

          <div class="form-group">
            <label>Cancha*:</label>
            <select [(ngModel)]="courtId">
              <option *ngFor="let court of courts" [value]="court.id">
                {{ court.name }} ({{ court.sportType }}) - ${{ court.pricePerHour }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label>Fecha*:</label>
            <input type="date" [(ngModel)]="reservationDate" />
          </div>

          <div class="form-group">
            <label>Hora inicio*:</label>
            <input type="time" [(ngModel)]="startTime" />
          </div>

          <div class="form-group">
            <label>Hora fin*:</label>
            <input type="time" [(ngModel)]="endTime" />
          </div>

          <div class="form-actions">
            <button (click)="submitForm()">
              {{ editMode ? 'Guardar Cambios' : 'Crear Reservaci√≥n' }}
            </button>
            <button type="button" (click)="cancelForm()">Cancelar</button>
          </div>
        </div>
      </div>

      <!-- Tabla de reservaciones -->
      <div class="table-container">
        <table class="usuarios-table">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Usuario</th>
              <th>Cancha</th>
              <th (click)="toggleSortByDate()" style="cursor: pointer;">
                Fecha
                <span *ngIf="sortDirection === 'asc'">‚ñ≤</span>
                <span *ngIf="sortDirection === 'desc'">‚ñº</span>
              </th>
              <th>Inicio</th>
              <th>Fin</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let res of filteredReservations">
              <td>{{ res.code }}</td>
              <td>{{ res.userFullName }}</td>
              <td>{{ res.courtName }}</td>
              <td>{{ res.date | date:'yyyy-MM-dd' }}</td>
              <td>{{ res.startTime }}</td>
              <td>{{ res.endTime }}</td>
              <td>{{ translateReservationStatus(res.status) }}</td>
              <td class="acciones">
                <!-- Editar: solo si NO est√° CANCELADA ni FINALIZADA -->
                <button class="edit-btn"
                        (click)="openForm(true, res)"
                        [disabled]="res.status === 'CANCELLED' || res.status === 'FINISHED'"
                        [matTooltip]="res.status === 'CANCELLED' ? 'No se puede editar: reserva cancelada' : res.status === 'FINISHED' ? 'No se puede editar: reserva finalizada' : ''">
                  ‚úèÔ∏è Editar
                </button>

                <!-- Cancelar: solo mostrar si NO est√° confirmada -->
                <button *ngIf="res.status !== 'CONFIRMED'"
                        class="delete-btn"
                        (click)="cancelReservation(res)"
                        [disabled]="res.status === 'CANCELLED'"
                        [matTooltip]="res.status === 'CANCELLED' ? 'Ya est√° cancelada' : ''">
                  üóëÔ∏è Cancelar
                </button>

                <!-- Reactivar: si estaba CANCELLED -->
                <button *ngIf="canReactivate(res)"
                        class="reactivate-btn"
                        (click)="reactivateReservation(res)">
                  ‚ôªÔ∏è Reactivar
                </button>

                <!-- Ver factura: solo si est√° CONFIRMED -->
                <button *ngIf="canShowInvoice(res)" class="invoice-btn" (click)="openInvoice(res)">
                  üìÑ Ver Factura
                </button>
              </td>
            </tr>
          </tbody>
        </table>
        <p *ngIf="filteredReservations.length === 0" class="no-results">
          No se encontraron reservaciones.
        </p>
      </div>
    </section>
  </main>
</div>
