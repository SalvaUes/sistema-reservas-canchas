<div class="dashboard">
  <!-- Panel lateral -->
  <aside
    class="side-panel"
    [class.closed]="isSidePanelClosed"
    (mouseenter)="hoverPanel(true)"
    (mouseleave)="hoverPanel(false)"
  >
    <button class="toggle-btn" (click)="toggleSidePanel()">
      {{ isSidePanelClosed ? '‚ò∞' : '‚úï' }}
    </button>
    <h2 *ngIf="!isSidePanelClosed">Panel Admin</h2>

    <nav>
      <a routerLink="/admin" routerLinkActive="active">
        <i class="fas fa-home"></i>
        <span *ngIf="!isSidePanelClosed">Inicio</span>
      </a>
      <a routerLink="/admin/usuarios" routerLinkActive="active">
        <i class="fas fa-users"></i>
        <span *ngIf="!isSidePanelClosed">Usuarios</span>
      </a>
      <a routerLink="/admin/canchas" routerLinkActive="active">
        <i class="fas fa-futbol"></i>
        <span *ngIf="!isSidePanelClosed">Canchas</span>
      </a>
      <a routerLink="/admin/reservas" routerLinkActive="active">
        <i class="fas fa-calendar-check"></i>
        <span *ngIf="!isSidePanelClosed">Reservas</span>
      </a>

    </nav>

    <div class="user-info" *ngIf="!isSidePanelClosed">
      <p>{{ userEmail }}</p>
      <p>{{ userRole }}</p>
    </div>

    <button class="logout-btn" (click)="logout()">
      <i class="fas fa-sign-out-alt"></i>
      <span *ngIf="!isSidePanelClosed">Cerrar sesi√≥n</span>
    </button>
  </aside>

  <!-- Contenido principal -->
  <main [class.closed]="isSidePanelClosed">
    <section class="usuarios-section">
      <h1>Usuarios</h1>

      <!-- Buscador -->
      <div class="users-toolbar">
        <div class="search-box">
          <input
          type="text"
          placeholder="Buscar por nombre o email, rol, estado ..."
          [(ngModel)]="searchTerm"
          (input)="filterUsers()"
          autocomplete="new-password"
          name="userSearch"
          spellcheck="false"
        />
      </div>

        <!-- Bot√≥n de a√±adir solo para ADMIN -->
        <button *ngIf="userRole === 'ADMIN'" class="add-btn" (click)="openForm(false)">
          A√±adir Usuario
        </button>
      </div>

      <!-- Modal formulario solo para ADMIN -->
      <div class="modal-backdrop" *ngIf="showForm && userRole === 'ADMIN'" (click)="cancelForm()">
        <div class="modal" (click)="$event.stopPropagation()">
          <h2>{{ editMode ? 'Editar Usuario' : 'Crear Nuevo Usuario' }}</h2>

          <div class="form-group">
            <label>Nombre*:</label>
            <input type="text" [(ngModel)]="firstName" maxlength="50" placeholder="M√°x. 50 caracteres"/>
          </div>
          <div class="form-group">
            <label>Apellido*:</label>
            <input type="text" [(ngModel)]="lastName" maxlength="50" placeholder="M√°x. 50 caracteres"/>
          </div>
          <div class="form-group">
            <label>Email*:</label>
            <input type="email" [(ngModel)]="email" maxlength="100" placeholder="M√°x. 100 caracteres"/>
          </div>
          <div class="form-group password-group">
            <label>Contrase√±a{{ editMode ? ' (opcional)' : '*' }}:</label>
            <div class="password-wrapper">
              <input
                [type]="showPassword ? 'text' : 'password'"
                [(ngModel)]="password"
                maxlength="20"
                autocomplete="new-password"
                [placeholder]="editMode ? 'Dejar vac√≠o si no deseas cambiar la contrase√±a' : 'M√°x. 20 caracteres'"
              />
              <button type="button" class="toggle-btn" (click)="togglePassword()">
                {{ showPassword ? 'Ocultar' : 'üëÅ Ver' }}
              </button>
            </div>
          </div>
          <div class="form-group">
            <label>Tel√©fono:</label>
            <input type="text" [(ngModel)]="phoneNumber" placeholder="Opcional"/>
          </div>
          <div class="form-group">
            <label>Rol:</label>
            <select [(ngModel)]="role">
              <option *ngFor="let r of roles" [value]="r">{{ r }}</option>
            </select>
          </div>

          <div class="form-actions">
            <button (click)="submitForm()">{{ editMode ? 'Guardar Cambios' : 'Crear Usuario' }}</button>
            <button type="button" (click)="cancelForm()">Cancelar</button>
          </div>
        </div>
      </div>

          <!-- Contenedor de selecci√≥n global y acciones masivas -->
          <div class="users-toolbar">
            <!-- Checkbox global -->
            <div class="select-global">
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  [checked]="selectAllGlobal"
                  (change)="toggleSelectAllGlobal($event)"
                />
                <span>Seleccionar todos los registros</span>
              </label>
            </div>

            <!-- Acciones masivas -->
            <div
              class="bulk-actions"
              *ngIf="selectedUsers.length > 0"
            >
              <button
                class="activate-btn"
                (click)="activateSelectedUsers()"
                [matTooltip]="selectedUsers.length === 0 ? 'No hay usuarios seleccionados para activar' : ''"
              >
                üîì Activar seleccionados
              </button>

              <button
                class="deactivate-btn"
                (click)="deactivateSelectedUsers()"
                [matTooltip]="selectedUsers.length === 0 ? 'No hay usuarios seleccionados para desactivar' : ''"
              >
                üîí Desactivar seleccionados
              </button>
            </div>
          </div>

          <!-- Tabla de usuarios -->
          <div class="table-container">
            <table class="usuarios-table">
              <thead>
                <tr>
                  <th>
                    <!-- Checkbox de la p√°gina -->
                    <input type="checkbox" [checked]="selectAllPage" (change)="toggleSelectAllPage($event)">
                  </th>
                  <th>Nombre</th>
                  <th>Email</th>
                  <th>Rol</th>
                  <th>Estado</th>
                  <th *ngIf="userRole === 'ADMIN'">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let user of paginatedUsers">
                  <td>
                    <input type="checkbox"
                      [checked]="selectedUsers.includes(user)"
                      (change)="toggleSelection(user, $event)"
                      [disabled]="user.email === userEmail">
                  </td>
                  <td>{{ user.firstName }} {{ user.lastName }}</td>
                  <td>{{ user.email }}</td>
                  <td>{{ user.roles[0]?.name }}</td>
                  <td>
                    <span [ngClass]="{'text-success': user.status === 'ACTIVE', 'text-danger': user.status === 'INACTIVE'}">
                      {{ user.status === 'ACTIVE' ? 'Activo' : 'Inactivo' }}
                    </span>
                  </td>
                  <td class="acciones" *ngIf="userRole === 'ADMIN'">
                    <button class="edit-btn" (click)="openForm(true, user)" [disabled]="user.status === 'INACTIVE'">‚úèÔ∏è Editar</button>
                    <button *ngIf="user.status === 'ACTIVE'" class="deactivate-btn" (click)="deactivateUser(user)">üîí Desactivar</button>
                    <button *ngIf="user.status === 'INACTIVE'" class="activate-btn" (click)="activateUser(user)">üîì Reactivar</button>
                  </td>
                </tr>
              </tbody>
            </table>

            <p *ngIf="filteredUsers.length === 0" class="no-results">No se encontraron usuarios.</p>
            <p>{{ selectedCount }} usuario(s) seleccionado(s)</p>

            <!-- üìÑ Controles de paginaci√≥n -->
            <div class="pagination" *ngIf="totalPages > 1">
              <button (click)="previousPage()" [disabled]="currentPage === 1">‚¨Ö Anterior</button>
              <span>P√°gina {{ currentPage }} de {{ totalPages }}</span>
              <button (click)="nextPage()" [disabled]="currentPage === totalPages">Siguiente ‚û°</button>
            </div>
          </div>
    </section>
</main>
