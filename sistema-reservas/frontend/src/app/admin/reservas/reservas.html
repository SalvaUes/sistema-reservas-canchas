<div class="dashboard">
  <!-- Panel lateral -->
  <aside
    class="side-panel"
    [class.closed]="isSidePanelClosed"
    (mouseenter)="hoverPanel(true)"
    (mouseleave)="hoverPanel(false)"
  >
    <button class="toggle-btn" (click)="toggleSidePanel()">
      {{ isSidePanelClosed ? '‚ò∞' : '‚úï' }}
    </button>
    <h2 *ngIf="!isSidePanelClosed">Panel Admin</h2>

    <nav>
      <a routerLink="/admin" routerLinkActive="active">
        <i class="fas fa-home"></i>
        <span *ngIf="!isSidePanelClosed">Inicio</span>
      </a>
      <a routerLink="/admin/usuarios" routerLinkActive="active">
        <i class="fas fa-users"></i>
        <span *ngIf="!isSidePanelClosed">Usuarios</span>
      </a>
      <a routerLink="/admin/canchas" routerLinkActive="active">
        <i class="fas fa-futbol"></i>
        <span *ngIf="!isSidePanelClosed">Canchas</span>
      </a>
      <a routerLink="/admin/reservas" routerLinkActive="active">
        <i class="fas fa-calendar-check"></i>
        <span *ngIf="!isSidePanelClosed">Reservas</span>
      </a>
    </nav>

    <div class="user-info" *ngIf="!isSidePanelClosed">
      <p>{{ userEmail }}</p>
      <p>{{ userRole }}</p>
    </div>

    <button class="logout-btn" (click)="logout()">
      <i class="fas fa-sign-out-alt"></i>
      <span *ngIf="!isSidePanelClosed">Cerrar sesi√≥n</span>
    </button>
  </aside>

  <!-- Contenido principal -->
  <main [class.closed]="isSidePanelClosed">
    <section class="reservas-section">
      <h1>Reservaciones</h1>

      <!-- üîç Buscador y filtro por estado -->
      <div class="reservas-toolbar">
        <div class="search-box">
          <input
            type="text"
            placeholder=" Buscar por usuario, cancha o c√≥digo..."
            [(ngModel)]="searchTerm"
            (input)="filterReservations()"
            autocomplete="off"
            spellcheck="false"
          />
        </div>

        <div class="filter-box">
          <label for="filterStatus">Estado:</label>
          <select
            id="filterStatus"
            [(ngModel)]="filterStatus"
            (change)="filterReservations()"
          >
            <option value="">Todos</option>
            <option value="PENDING">Pendiente</option>
            <option value="CONFIRMED">Confirmada</option>
            <option value="FINISHED">Finalizada</option>
            <option value="CANCELLED">Cancelada</option>
          </select>
        </div>
      </div>

      <!-- Modal formulario de edici√≥n -->
      <div
        class="modal-backdrop"
        *ngIf="showForm"
        (click)="cancelForm()"
      >
        <div class="modal" (click)="$event.stopPropagation()">
          <h2>Editar Reservaci√≥n</h2>

          <div class="form-group">
            <label>Usuario*:</label>
            <select [(ngModel)]="userId">
              <option *ngFor="let user of users" [value]="user.id">
                {{ user.firstName }} {{ user.lastName }} ({{ user.email }})
              </option>
            </select>
          </div>

          <div class="form-group">
            <label>Cancha*:</label>
            <select [(ngModel)]="courtId">
              <option *ngFor="let court of courts" [value]="court.id">
                {{ court.name }} ({{ court.sportType }}) - ${{ court.pricePerHour }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label>Fecha*:</label>
            <input type="date" [(ngModel)]="reservationDate" />
          </div>

          <div class="form-group">
            <mat-form-field appearance="outline">
              <mat-label>Hora inicio*</mat-label>
              <input
                matInput
                [matTimepicker]="pickerStart"
                [(ngModel)]="startTimeDisplay"
                placeholder="10:30 AM"
                (ngModelChange)="onStartTimeChange($event)"
              />
              <mat-timepicker-toggle matSuffix [for]="pickerStart"></mat-timepicker-toggle>
              <mat-timepicker #pickerStart></mat-timepicker>
            </mat-form-field>
          </div>

          <div class="form-group">
            <mat-form-field appearance="outline">
              <mat-label>Hora fin*</mat-label>
              <input
                matInput
                [matTimepicker]="pickerEnd"
                [(ngModel)]="endTimeDisplay"
                placeholder="02:00 PM"
                (ngModelChange)="onEndTimeChange($event)"
              />
              <mat-timepicker-toggle matSuffix [for]="pickerEnd"></mat-timepicker-toggle>
              <mat-timepicker #pickerEnd></mat-timepicker>
            </mat-form-field>
          </div>

          <p>Hora inicio 24h: {{ startTime }}</p>
          <p>Hora fin 24h: {{ endTime }}</p>

          <div class="form-actions">
            <button (click)="submitForm()">Guardar Cambios</button>
            <button type="button" (click)="cancelForm()">Cancelar</button>
          </div>
        </div>
      </div>

      <!-- Contenedor de selecci√≥n global y acciones masivas -->
      <div class="reservas-toolbar">
        <!-- Checkbox global -->
        <div class="select-global">
          <label class="checkbox-label">
            <input
              type="checkbox"
              [checked]="selectAllGlobal"
              (change)="toggleSelectAllGlobal($event)"
            />
            <span>Seleccionar todas las reservas filtradas</span>
            
          </label>
        </div>

        <!-- Acciones masivas -->
        <div
          class="bulk-actions"
          *ngIf="selectedReservations.length > 0 || selectedReservationsReactivate.length > 0"
        >
          <button
            class="delete-btn"
            (click)="cancelSelected()"
            [disabled]="selectedReservations.length === 0"
            [matTooltip]="selectedReservations.length === 0 ? 'No hay reservaciones seleccionadas para cancelar' : ''"
          >
            üóëÔ∏è Cancelar seleccionadas
          </button>

          <button
            class="reactivate-btn"
            (click)="reactivateSelected()"
            [disabled]="selectedReservationsReactivate.length === 0"
            [matTooltip]="selectedReservationsReactivate.length === 0 ? 'No hay reservaciones seleccionadas para reactivar' : ''"
          >
            ‚ôªÔ∏è Reactivar seleccionadas
          </button>
        </div>
      </div>

      <p></p>
      <!-- Tabla de reservaciones -->
        <div class="table-container">
          <table class="usuarios-table">
            <thead>
              <tr>
                <th>
                  <input type="checkbox" [checked]="areAllSelected()" (change)="toggleSelectAll($event)" />
                </th>
                <th>C√≥digo</th>
                <th>Usuario</th>
                <th>Cancha</th>
                <th (click)="toggleSortByDate()" style="cursor:pointer;">
                  Fecha
                  <span *ngIf="sortDirection==='asc'">‚ñ≤</span>
                  <span *ngIf="sortDirection==='desc'">‚ñº</span>
                </th>
                <th>Inicio</th>
                <th>Fin</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let res of pagedReservations">
                <td>
                  <input
                    type="checkbox"
                    [(ngModel)]="res.selected"
                    (change)="onReservationSelect(res, $event)"
                    [disabled]="res.status === 'CONFIRMED' || res.status === 'FINISHED' || (res.status === 'CANCELLED' && !canSelectForReactivation(res))"
                  />
                </td>
                <td>{{ res.code }}</td>
                <td>{{ res.userFullName }}</td>
                <td>{{ res.courtName }}</td>
                <td>{{ res.date | date:'yyyy-MM-dd' }}</td>
                <td>{{ res.startTime }}</td>
                <td>{{ res.endTime }}</td>
                <td [class]="res.status.toLowerCase()">{{ translateReservationStatus(res.status) }}</td>
                <td class="acciones">
                  <button class="edit-btn"
                          (click)="openForm(true,res)"
                          [disabled]="res.status==='CANCELLED' || res.status==='FINISHED' || res.status==='CONFIRMED'"
                          [matTooltip]="
                            res.status==='CANCELLED' ? 'No se puede editar: cancelada' :
                            res.status==='FINISHED' ? 'No se puede editar: finalizada' :
                            res.status==='CONFIRMED' ? 'No se puede editar: confirmada' :
                            ''
                          "
                          >
                  ‚úèÔ∏è Editar
                  </button>

                  <button *ngIf="res.status!=='CONFIRMED'" class="delete-btn"
                          (click)="cancelReservation(res)"
                          [disabled]="res.status==='CANCELLED'">
                    üóëÔ∏è Cancelar
                  </button>

                  <!-- Bot√≥n Reactivar (solo si se puede) -->
                  <button *ngIf="canReactivate(res)" 
                          class="reactivate-btn" 
                          (click)="reactivateReservation(res)">
                    ‚ôªÔ∏è Reactivar
                  </button>

                  <!-- Solo mostrar eliminar si est√° cancelada y no puede reactivarse -->
                    <button *ngIf="canDeleteCancelled(res)" 
                            class="delete-btn" 
                            (click)="deleteReservation(res)">
                      üóëÔ∏è Eliminar
                    </button>

                  <button *ngIf="canShowInvoice(res)" class="invoice-btn" (click)="openInvoice(res)">
                    üìÑ Factura
                  </button>
                </td>
              </tr>
            </tbody>
          </table>

          <p *ngIf="filteredReservations.length === 0" class="no-results">
            No se encontraron reservaciones.
          </p>
          <p>{{ selectedReservations.length + selectedReservationsReactivate.length }} reserva(s) seleccionada(s)</p>

          <!-- Paginaci√≥n -->
          <div class="pagination" *ngIf="totalPages > 1">
            <button (click)="previousPage()" [disabled]="currentPage === 1">‚¨Ö Anterior</button>
            <span>P√°gina {{ currentPage }} de {{ totalPages }}</span>
            <button (click)="nextPage()" [disabled]="currentPage === totalPages">Siguiente ‚û°</button>
          </div>
        </div>
    </section>
  </main>
</div>
